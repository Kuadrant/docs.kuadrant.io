
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://docs.kuadrant.io/dev/kuadrant-operator/doc/user-guides/dns/core-dns/">
      
      
        <link rel="prev" href="../dnshealthchecks/">
      
      
        <link rel="next" href="../understanding_dns_delegation/">
      
      
      <link rel="icon" href="../../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.44">
    
    
      
        <title>CoreDNS Support - Kuadrant Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/main.0253249f.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../../../assets/stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#coredns-with-kuadrant" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
          <aside class="md-banner md-banner--warning">
            <div class="md-banner__inner md-grid md-typeset">
              
  These docs are not for the latest version.
  <a href="../../../../../.."> 
    <strong>Click here to go to latest, stable docs.</strong>
  </a>

            </div>
            <script>var el=document.querySelector("[data-md-component=outdated]"),outdated=__md_get("__outdated",sessionStorage);!0===outdated&&el&&(el.hidden=!1)</script>
          </aside>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../../.." title="Kuadrant Documentation" class="md-header__button md-logo" aria-label="Kuadrant Documentation" data-md-component="logo">
      
  <img src="../../../../../assets/images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Kuadrant Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              CoreDNS Support
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/kuadrant/docs.kuadrant.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../../.." title="Kuadrant Documentation" class="md-nav__button md-logo" aria-label="Kuadrant Documentation" data-md-component="logo">
      
  <img src="../../../../../assets/images/logo.png" alt="logo">

    </a>
    Kuadrant Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/kuadrant/docs.kuadrant.io" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../getting-started/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Installation
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Installation
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../install-helm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Install with Helm
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../install-olm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Install with OLM
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Concepts
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Concepts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../architecture/docs/design/architectural-overview-v1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Architecture
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../overviews/auth/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AuthPolicy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../overviews/dns/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DNSPolicy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../overviews/rate-limiting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RateLimitPolicy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../overviews/tls/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TLSPolicy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../overviews/token-rate-limiting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TokenRateLimitPolicy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../overviews/telemetrypolicy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TelemetryPolicy
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    APIs & Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            APIs & Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/authpolicy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AuthPolicy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/dnspolicy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DNSPolicy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/ratelimitpolicy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RateLimitPolicy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/tlspolicy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TLSPolicy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/tokenratelimitpolicy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TokenRateLimitPolicy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/kuadrant/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kuadrant
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_7" >
        
          
          <label class="md-nav__link" for="__nav_5_7" id="__nav_5_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Observability
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_7">
            <span class="md-nav__icon md-icon"></span>
            Observability
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../observability/metrics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Metrics
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../authorino/docs/user-guides/observability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Authentication and Authorization
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/telemetrypolicy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    TelemetryPolicy
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tutorials
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../full-walkthrough/secure-protect-connect/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Secure, connect and protect
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tls/gateway-tls/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Gateway TLS for Cluster Operators
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../auth/auth-for-app-devs-and-platform-engineers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Enforcing authentication & authorization with Kuadrant AuthPolicy
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ratelimiting/gateway-rl-for-cluster-operators/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Gateway Rate Limiting for Cluster Operators
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ratelimiting/authenticated-rl-for-app-developers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Authenticated Rate Limiting for Application Developers
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ratelimiting/authenticated-rl-with-jwt-and-k8s-authnz/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Authenticated Rate Limiting with JWTs and Kubernetes RBAC
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ratelimiting/multi-auth-rlp-diff-section/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Gateway Rate Limiting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ratelimiting/multi-auth-rlp-same-section/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Multi authenticated Rate Limiting for an Application
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tokenratelimitpolicy/authenticated-token-ratelimiting-tutorial/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Authenticated Token Rate Limiting for Large Language Model APIs
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" checked>
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Guides
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_1" checked>
        
          
          <label class="md-nav__link" for="__nav_7_1" id="__nav_7_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    DNS configuration
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_7_1">
            <span class="md-nav__icon md-icon"></span>
            DNS configuration
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../../../dns-operator/docs/provider/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuring a DNS Provider
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../gateway-dns/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Gateway DNS for ingress Gateway
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../basic-dns-configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Basic DNS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../load-balanced-dns/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    DNS Load Balancing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dnshealthchecks/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Health Checks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    CoreDNS Support
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    CoreDNS Support
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#coredns-with-kuadrant" class="md-nav__link">
    <span class="md-ellipsis">
      CoreDNS with Kuadrant
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CoreDNS with Kuadrant">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      Prerequisites
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Prerequisites">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#local-kind-clusters-optional" class="md-nav__link">
    <span class="md-ellipsis">
      Local Kind clusters [Optional]
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup-cluster-1-and-2-primary" class="md-nav__link">
    <span class="md-ellipsis">
      Setup Cluster 1 and 2 (Primary)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Setup Cluster 1 and 2 (Primary)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-coredns" class="md-nav__link">
    <span class="md-ellipsis">
      Install CoreDNS
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Install CoreDNS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#openshift-on-aws" class="md-nav__link">
    <span class="md-ellipsis">
      OpenShift on AWS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verify" class="md-nav__link">
    <span class="md-ellipsis">
      Verify
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zone-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Zone Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-a-geo-ip-database" class="md-nav__link">
    <span class="md-ellipsis">
      Using a GEO IP database
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delegate-the-zones-public-cluster-only" class="md-nav__link">
    <span class="md-ellipsis">
      Delegate the zones (public cluster only)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dns-operator-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      DNS Operator Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-cluster-kubeconfig-secrets" class="md-nav__link">
    <span class="md-ellipsis">
      Add Cluster Kubeconfig Secrets
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Add Cluster Kubeconfig Secrets">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#verify_1" class="md-nav__link">
    <span class="md-ellipsis">
      Verify
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-test-namespace-dnstest" class="md-nav__link">
    <span class="md-ellipsis">
      Create test namespace (dnstest)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Create test namespace (dnstest)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#add-coredns-provider-secrets" class="md-nav__link">
    <span class="md-ellipsis">
      Add coredns provider secrets
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup-cluster-3-secondary" class="md-nav__link">
    <span class="md-ellipsis">
      Setup Cluster 3 (Secondary)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Setup Cluster 3 (Secondary)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dns-operator-configuration_1" class="md-nav__link">
    <span class="md-ellipsis">
      DNS Operator Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-test-namespace-dnstest_1" class="md-nav__link">
    <span class="md-ellipsis">
      Create test namespace (dnstest)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-toystore-application" class="md-nav__link">
    <span class="md-ellipsis">
      Deploy Toystore application
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Deploy Toystore application">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-an-ingress-gateway" class="md-nav__link">
    <span class="md-ellipsis">
      Create an Ingress Gateway
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup-toystore-application-httproute" class="md-nav__link">
    <span class="md-ellipsis">
      Setup Toystore application HTTPRoute
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verify_2" class="md-nav__link">
    <span class="md-ellipsis">
      Verify
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enable-dns-on-the-gateway" class="md-nav__link">
    <span class="md-ellipsis">
      Enable DNS on the gateway
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verify_3" class="md-nav__link">
    <span class="md-ellipsis">
      Verify
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../understanding_dns_delegation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Cluster Aware DNSRecord Delegation
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../install/mtls-configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mTLS Configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7_3" >
        
          
          <label class="md-nav__link" for="__nav_7_3" id="__nav_7_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Observability
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_7_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7_3">
            <span class="md-nav__icon md-icon"></span>
            Observability
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../observability/monitors/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configure Observability
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../observability/examples/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Dashboards and Alerts
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../observability/tracing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Tracing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../observability/limitador-metrics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Monitoring Limitador
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../observability/token-metrics/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Monitoring AI Token Metrics
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#coredns-with-kuadrant" class="md-nav__link">
    <span class="md-ellipsis">
      CoreDNS with Kuadrant
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CoreDNS with Kuadrant">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      Prerequisites
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Prerequisites">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#local-kind-clusters-optional" class="md-nav__link">
    <span class="md-ellipsis">
      Local Kind clusters [Optional]
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup-cluster-1-and-2-primary" class="md-nav__link">
    <span class="md-ellipsis">
      Setup Cluster 1 and 2 (Primary)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Setup Cluster 1 and 2 (Primary)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#install-coredns" class="md-nav__link">
    <span class="md-ellipsis">
      Install CoreDNS
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Install CoreDNS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#openshift-on-aws" class="md-nav__link">
    <span class="md-ellipsis">
      OpenShift on AWS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verify" class="md-nav__link">
    <span class="md-ellipsis">
      Verify
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#zone-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Zone Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-a-geo-ip-database" class="md-nav__link">
    <span class="md-ellipsis">
      Using a GEO IP database
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delegate-the-zones-public-cluster-only" class="md-nav__link">
    <span class="md-ellipsis">
      Delegate the zones (public cluster only)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dns-operator-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      DNS Operator Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#add-cluster-kubeconfig-secrets" class="md-nav__link">
    <span class="md-ellipsis">
      Add Cluster Kubeconfig Secrets
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Add Cluster Kubeconfig Secrets">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#verify_1" class="md-nav__link">
    <span class="md-ellipsis">
      Verify
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-test-namespace-dnstest" class="md-nav__link">
    <span class="md-ellipsis">
      Create test namespace (dnstest)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Create test namespace (dnstest)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#add-coredns-provider-secrets" class="md-nav__link">
    <span class="md-ellipsis">
      Add coredns provider secrets
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setup-cluster-3-secondary" class="md-nav__link">
    <span class="md-ellipsis">
      Setup Cluster 3 (Secondary)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Setup Cluster 3 (Secondary)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dns-operator-configuration_1" class="md-nav__link">
    <span class="md-ellipsis">
      DNS Operator Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-test-namespace-dnstest_1" class="md-nav__link">
    <span class="md-ellipsis">
      Create test namespace (dnstest)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-toystore-application" class="md-nav__link">
    <span class="md-ellipsis">
      Deploy Toystore application
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Deploy Toystore application">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#create-an-ingress-gateway" class="md-nav__link">
    <span class="md-ellipsis">
      Create an Ingress Gateway
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#setup-toystore-application-httproute" class="md-nav__link">
    <span class="md-ellipsis">
      Setup Toystore application HTTPRoute
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verify_2" class="md-nav__link">
    <span class="md-ellipsis">
      Verify
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#enable-dns-on-the-gateway" class="md-nav__link">
    <span class="md-ellipsis">
      Enable DNS on the gateway
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#verify_3" class="md-nav__link">
    <span class="md-ellipsis">
      Verify
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/kuadrant/kuadrant-operator/blob/main/doc/user-guides/dns/core-dns.md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


  <h1>CoreDNS Support</h1>

<h2 id="coredns-with-kuadrant">CoreDNS with Kuadrant<a class="headerlink" href="#coredns-with-kuadrant" title="Permanent link">&para;</a></h2>
<p>With this guide, you will learn how to setup Kuadrant to use CoreDNS via the Kuadrant <code>DNSPolicy</code> and leverage CoreDNS as the authoritative nameserver(s) for a given domain shared across multiple gateways to provide both a weighted and GEO based DNS response similar to that offered by common cloud providers.</p>
<blockquote>
<p>Note: Core DNS support is intended for evaluation and feedback only. This guide makes use of a developer preview version of the CoreDNS integration and is <strong>not</strong> intended for production use.</p>
</blockquote>
<p>The basic architecture for how the CoreDNS integration works is shown in the image below:</p>
<p><img alt="architecture" src="../core-dns.png" /></p>
<h3 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h3>
<p>Kuadrant's DNS Operator will create an authoritative DNSRecord for any DNSRecord that reference a CoreDNS provider secret directly or via a "default" provider secret.
The authoritative record is named and labeled in a deterministic way using the source DNSRecord root host and contains all the endpoints related to that root host which could be coming from multiple DNSRecord sources.
The DNS Operator can be configured to read DNSRecords from multiple clusters allowing DNSRecords in the same namespace with the same root host to form a single authoritative merged record set on selected "primary" clusters. 
Kuadrant's custom CoreDNS plugin, will read and serve the authoritative record. 
If there is provider specific meta data for weight and GEO, the kuadrant plugin will apply GEO location filtering (assuming there is an appropriate GEO database configured) and a weighted response to any DNS queries for the dns names in those records.</p>
<p>This guide shows the manual steps required to configure the kuadrant CoreDNS integration in a multi cluster setup (Two primary clusters and one secondary).  </p>
<h2 id="prerequisites">Prerequisites<a class="headerlink" href="#prerequisites" title="Permanent link">&para;</a></h2>
<ul>
<li>Kubernetes cluster(s) (Three to test all functionality described in this guide)</li>
<li>Kuadrant installed on each cluster</li>
</ul>
<h3 id="local-kind-clusters-optional">Local Kind clusters [Optional]<a class="headerlink" href="#local-kind-clusters-optional" title="Permanent link">&para;</a></h3>
<p>If you want to see how this works locally and are not using existing clusters, the easiest approach is to use kind to create local clusters.</p>
<p>To try this out you can use the local-setup helper from the kuadrant-operator repo:
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>git clone https://github.com/Kuadrant/kuadrant-operator.git
</span></code></pre></div></p>
<p>Run the following from the root of the repo:
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="nv">CLUSTER_COUNT</span><span class="o">=</span><span class="m">3</span><span class="w"> </span>./hack/multicluster.sh<span class="w"> </span>local-setup
</span></code></pre></div></p>
<p>This will create three local Kind clusters with Kuadrant installed, you can set the context env vars used in the rest of this guide by running the following:
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="nb">export</span><span class="w"> </span><span class="nv">CTX_PRIMARY1</span><span class="o">=</span>kind-kuadrant-local-1
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="nb">export</span><span class="w"> </span><span class="nv">CTX_PRIMARY2</span><span class="o">=</span>kind-kuadrant-local-2
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="nb">export</span><span class="w"> </span><span class="nv">CTX_SECONDARY1</span><span class="o">=</span>kind-kuadrant-local-3
</span></code></pre></div></p>
<h2 id="setup-cluster-1-and-2-primary">Setup Cluster 1 and 2 (Primary)<a class="headerlink" href="#setup-cluster-1-and-2-primary" title="Permanent link">&para;</a></h2>
<p>At least one cluster must be configured as a primary. 
A primary cluster that is intended to be used with the CoreDNS provider should have a CoreDNS instance running with the Kuadrant plugin enabled.
A primary cluster should have cluster kubeconfig secrets added for all other clusters.
A primary cluster should have dns provider (coredns) secrets in target namespaces.</p>
<h3 id="install-coredns">Install CoreDNS<a class="headerlink" href="#install-coredns" title="Permanent link">&para;</a></h3>
<p>You can install CoreDNS configured with the kuadrant plugin using the follow kustomize command while kubectl is targeting the desired cluster, this will install CoreDNS into the <code>kuadrant-coredns</code> namespace:
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>kustomize<span class="w"> </span>build<span class="w"> </span>--enable-helm<span class="w"> </span>https://github.com/Kuadrant/dns-operator/config/coredns<span class="w"> </span><span class="p">|</span><span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY1</span><span class="si">}</span><span class="w"> </span>-f<span class="w"> </span>-
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>kustomize<span class="w"> </span>build<span class="w"> </span>--enable-helm<span class="w"> </span>https://github.com/Kuadrant/dns-operator/config/coredns<span class="w"> </span><span class="p">|</span><span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY2</span><span class="si">}</span><span class="w"> </span>-f<span class="w"> </span>-
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>kubectl<span class="w"> </span><span class="nb">wait</span><span class="w"> </span>--timeout<span class="o">=</span>90s<span class="w"> </span>--for<span class="o">=</span><span class="nv">condition</span><span class="o">=</span><span class="nv">Ready</span><span class="o">=</span>True<span class="w"> </span>pods<span class="w"> </span>-A<span class="w"> </span>-l<span class="w"> </span>app.kubernetes.io/name<span class="o">=</span>coredns<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY1</span><span class="si">}</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>kubectl<span class="w"> </span><span class="nb">wait</span><span class="w"> </span>--timeout<span class="o">=</span>90s<span class="w"> </span>--for<span class="o">=</span><span class="nv">condition</span><span class="o">=</span><span class="nv">Ready</span><span class="o">=</span>True<span class="w"> </span>pods<span class="w"> </span>-A<span class="w"> </span>-l<span class="w"> </span>app.kubernetes.io/name<span class="o">=</span>coredns<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY2</span><span class="si">}</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>kubectl<span class="w"> </span>get<span class="w"> </span>deployments<span class="w"> </span>-A<span class="w"> </span>-l<span class="w"> </span>app.kubernetes.io/name<span class="o">=</span>coredns<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY1</span><span class="si">}</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>kubectl<span class="w"> </span>get<span class="w"> </span>deployments<span class="w"> </span>-A<span class="w"> </span>-l<span class="w"> </span>app.kubernetes.io/name<span class="o">=</span>coredns<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY2</span><span class="si">}</span>
</span></code></pre></div></p>
<h4 id="openshift-on-aws">OpenShift on AWS<a class="headerlink" href="#openshift-on-aws" title="Permanent link">&para;</a></h4>
<p>If you are using an OpenShift cluster on AWS you will also need to run the following commands:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>kubectl<span class="w"> </span>patch<span class="w"> </span>service<span class="w"> </span>kuadrant-coredns<span class="w"> </span>--type<span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="w"> </span>-p<span class="o">=</span><span class="s1">&#39;[{&quot;op&quot;: &quot;remove&quot;, &quot;path&quot;: &quot;/spec/externalTrafficPolicy&quot;}]&#39;</span><span class="w"> </span>-n<span class="w"> </span>kuadrant-coredns<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY1</span><span class="si">}</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>kubectl<span class="w"> </span>patch<span class="w"> </span>service<span class="w"> </span>kuadrant-coredns<span class="w"> </span>--type<span class="o">=</span><span class="s1">&#39;json&#39;</span><span class="w"> </span>-p<span class="o">=</span><span class="s1">&#39;[{&quot;op&quot;: &quot;remove&quot;, &quot;path&quot;: &quot;/spec/externalTrafficPolicy&quot;}]&#39;</span><span class="w"> </span>-n<span class="w"> </span>kuadrant-coredns<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY2</span><span class="si">}</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>kubectl<span class="w"> </span>annotate<span class="w"> </span>service/kuadrant-coredns<span class="w"> </span>service.beta.kubernetes.io/aws-load-balancer-type<span class="o">=</span>nlb<span class="w"> </span>-n<span class="w"> </span>kuadrant-coredns<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY1</span><span class="si">}</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>kubectl<span class="w"> </span>annotate<span class="w"> </span>service/kuadrant-coredns<span class="w"> </span>service.beta.kubernetes.io/aws-load-balancer-type<span class="o">=</span>nlb<span class="w"> </span>-n<span class="w"> </span>kuadrant-coredns<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY2</span><span class="si">}</span>
</span></code></pre></div>
<blockquote>
<p>Note: OpenShift on AWS does not currently support exposing a single port on both UDP and TCP, so in this setup only UDP port 53 is exposed via the ELB.</p>
</blockquote>
<h4 id="verify">Verify<a class="headerlink" href="#verify" title="Permanent link">&para;</a></h4>
<p>Check that the CoreDNS instances are available and responding to queries:
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="nv">NS1</span><span class="o">=</span><span class="sb">`</span>kubectl<span class="w"> </span>get<span class="w"> </span>service/kuadrant-coredns<span class="w"> </span>-n<span class="w"> </span>kuadrant-coredns<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY1</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>yq<span class="w"> </span><span class="s1">&#39;.status.loadBalancer.ingress[0].ip&#39;</span><span class="sb">`</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="nv">NS2</span><span class="o">=</span><span class="sb">`</span>kubectl<span class="w"> </span>get<span class="w"> </span>service/kuadrant-coredns<span class="w"> </span>-n<span class="w"> </span>kuadrant-coredns<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY2</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>yq<span class="w"> </span><span class="s1">&#39;.status.loadBalancer.ingress[0].ip&#39;</span><span class="sb">`</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="nb">echo</span><span class="w"> </span><span class="nv">$NS1</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="nb">echo</span><span class="w"> </span><span class="nv">$NS2</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>dig<span class="w"> </span>@<span class="si">${</span><span class="nv">NS1</span><span class="si">}</span><span class="w"> </span>-t<span class="w"> </span>AXFR<span class="w"> </span>k.example.com
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>dig<span class="w"> </span>@<span class="si">${</span><span class="nv">NS2</span><span class="si">}</span><span class="w"> </span>-t<span class="w"> </span>AXFR<span class="w"> </span>k.example.com
</span></code></pre></div></p>
<h4 id="zone-configuration">Zone Configuration<a class="headerlink" href="#zone-configuration" title="Permanent link">&para;</a></h4>
<p>A default zone (k.example.com) is created for testing purposes.
This can be replaced, or additional zones added, as desired by modifying the "Corefile" on each primary cluster.</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>configmap/kuadrant-coredns<span class="w"> </span>-n<span class="w"> </span>kuadrant-coredns<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY1</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>yq<span class="w"> </span>.data
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>kubectl<span class="w"> </span>get<span class="w"> </span>configmap/kuadrant-coredns<span class="w"> </span>-n<span class="w"> </span>kuadrant-coredns<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY2</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>yq<span class="w"> </span>.data
</span></code></pre></div>
<p>The sample CoreDNS configuration is generated from this file: <a href="https://raw.githubusercontent.com/Kuadrant/dns-operator/refs/heads/main/config/coredns/Corefile">CoreDNS Configuration</a>. 
That domain name can be changed or duplicated to add other domains as required.</p>
<p>For more information on configuring CoreDNS please refer to their <a href="https://coredns.io/manual/configuration/">documentation</a>.</p>
<h4 id="using-a-geo-ip-database">Using a GEO IP database<a class="headerlink" href="#using-a-geo-ip-database" title="Permanent link">&para;</a></h4>
<p>The CoreDNS instances will need to be configured to use a GEO IP database, in the example above this is called: <code>GeoLite2-City-demo.mmdb</code>. 
This is a mock database we provide to for illustrative purposes. 
Change this to refer to your maxmind database file, for more information see <a href="https://www.maxmind.com/en/geoip-databases">here</a>.</p>
<p>For more information on configuring the CoreDNS geoip plugin please refer to their <a href="https://coredns.io/plugins/geoip/">documentation</a>.</p>
<h4 id="delegate-the-zones-public-cluster-only">Delegate the zones (public cluster only)<a class="headerlink" href="#delegate-the-zones-public-cluster-only" title="Permanent link">&para;</a></h4>
<p>This cannot be done when testing locally, but assuming the CoreDNS instance is running on a publicly accessible IP which permits traffic on port 53, then the zone(s) in use will need to be delegated to these nameservers.
For testing and evaluation we would recommend creating a fresh zone.</p>
<p>This is done by creating an NS record in the zone hosted by the authoritative nameserver.</p>
<p>For example, if there is a domain example.com with authoritative nameservers in Route53, and 2 CoreDNS instances are configured with the zone k.example.com (on IPs 1.2.3.4 and 2.3.4.5).
Then in the example.com zone in Route53 the following records need to be created:
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>coredns1.example.com. IN A 60 1.2.3.4
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a>coredns2.example.com. IN A 60 2.3.4.5
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a>k.example.com. IN NS 300 coredns1.example.com.
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>k.example.com. IN NS 300 coredns2.example.com.
</span></code></pre></div></p>
<p>If the CoreDNS instances are not publicly accessible, then we will be able to verify them using the <code>@</code> modifier on a dig command.</p>
<h3 id="dns-operator-configuration">DNS Operator Configuration<a class="headerlink" href="#dns-operator-configuration" title="Permanent link">&para;</a></h3>
<p>Clusters being configured as "primary" should have the delegation role of the running dns operator set to "primary".
This is currently the default so nothing needs to be done here.</p>
<h3 id="add-cluster-kubeconfig-secrets">Add Cluster Kubeconfig Secrets<a class="headerlink" href="#add-cluster-kubeconfig-secrets" title="Permanent link">&para;</a></h3>
<p>In order for each primary cluster to read DNSRecord resources from all other clusters (primary or secondary) a cluster secret containing kubeconfig data for each of the other clusters must be added.
The <code>kubectl-dns</code> plugin provides a command to help create a valid cluster secret from the expected service account on the target cluster.</p>
<p>Refer to the <a href="https://github.com/Kuadrant/dns-operator/blob/main/docs/cli.md">CLI documentation</a> for more information on how to install the plugin.</p>
<p>Assuming the <code>kubectl-dns</code> plugin is in the system path, you can run the following to connect all clusters to each primary:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="c1"># Set current context to primary 1</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a>kubectl<span class="w"> </span>config<span class="w"> </span>use-context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY1</span><span class="si">}</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a>kubectl-dns<span class="w"> </span>secret-generation<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY2</span><span class="si">}</span><span class="w"> </span>--namespace<span class="w"> </span>kuadrant-system
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>kubectl-dns<span class="w"> </span>secret-generation<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_SECONDARY1</span><span class="si">}</span><span class="w"> </span>--namespace<span class="w"> </span>kuadrant-system
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="c1"># Set current context to primary 2</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a>kubectl<span class="w"> </span>config<span class="w"> </span>use-context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY2</span><span class="si">}</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a>kubectl-dns<span class="w"> </span>secret-generation<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY1</span><span class="si">}</span><span class="w"> </span>--namespace<span class="w"> </span>kuadrant-system
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a>kubectl-dns<span class="w"> </span>secret-generation<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_SECONDARY1</span><span class="si">}</span><span class="w"> </span>--namespace<span class="w"> </span>kuadrant-system
</span></code></pre></div>
<p>If you are using Kind clusters (created via <code>./hack/multicluster.sh</code>) the above will produce invalid kubeconfig data. 
As a temporary workaround you can run the following from the root of the kuadrant-operator repo:
<div class="language-shell highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>../../../hack/multicluster.sh<span class="w"> </span>create-cluster-secret<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY1</span><span class="si">}</span><span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY2</span><span class="si">}</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>../../../hack/multicluster.sh<span class="w"> </span>create-cluster-secret<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY1</span><span class="si">}</span><span class="w"> </span><span class="si">${</span><span class="nv">CTX_SECONDARY1</span><span class="si">}</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>../../../hack/multicluster.sh<span class="w"> </span>create-cluster-secret<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY2</span><span class="si">}</span><span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY1</span><span class="si">}</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>../../../hack/multicluster.sh<span class="w"> </span>create-cluster-secret<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY2</span><span class="si">}</span><span class="w"> </span><span class="si">${</span><span class="nv">CTX_SECONDARY1</span><span class="si">}</span>
</span></code></pre></div></p>
<h4 id="verify_1">Verify<a class="headerlink" href="#verify_1" title="Permanent link">&para;</a></h4>
<p>Check the cluster secrets exist on the primary clusters:
<div class="language-shell highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>secret<span class="w"> </span>-A<span class="w"> </span>-l<span class="w"> </span>kuadrant.io/multicluster-kubeconfig<span class="o">=</span><span class="nb">true</span><span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY1</span><span class="si">}</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>kubectl<span class="w"> </span>get<span class="w"> </span>secret<span class="w"> </span>-A<span class="w"> </span>-l<span class="w"> </span>kuadrant.io/multicluster-kubeconfig<span class="o">=</span><span class="nb">true</span><span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY2</span><span class="si">}</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>kubectl<span class="w"> </span>get<span class="w"> </span>secret<span class="w"> </span>-A<span class="w"> </span>-l<span class="w"> </span>kuadrant.io/multicluster-kubeconfig<span class="o">=</span><span class="nb">true</span><span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_SECONDARY1</span><span class="si">}</span>
</span></code></pre></div></p>
<p>Check the cluster secret content is valid kubeconfig data:
<div class="language-shell highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>secret<span class="w"> </span>kind-kuadrant-local-2<span class="w"> </span>-n<span class="w"> </span>kuadrant-system<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY1</span><span class="si">}</span><span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.data.kubeconfig}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="w"> </span>-d
</span></code></pre></div></p>
<h3 id="create-test-namespace-dnstest">Create test namespace (dnstest)<a class="headerlink" href="#create-test-namespace-dnstest" title="Permanent link">&para;</a></h3>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>kubectl<span class="w"> </span>create<span class="w"> </span>ns<span class="w"> </span>dnstest<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY1</span><span class="si">}</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>kubectl<span class="w"> </span>create<span class="w"> </span>ns<span class="w"> </span>dnstest<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY2</span><span class="si">}</span>
</span></code></pre></div>
<h4 id="add-coredns-provider-secrets">Add coredns provider secrets<a class="headerlink" href="#add-coredns-provider-secrets" title="Permanent link">&para;</a></h4>
<p>The CoreDNS provider secret should be created with the desired zones configured. In this case we create it for the test zone (k.example.com):
<div class="language-shell highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>kubectl<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>generic<span class="w"> </span>dns-provider-coredns<span class="w"> </span>--namespace<span class="o">=</span>dnstest<span class="w"> </span>--type<span class="o">=</span>kuadrant.io/coredns<span class="w"> </span>--from-literal<span class="o">=</span><span class="nv">ZONES</span><span class="o">=</span><span class="s2">&quot;k.example.com&quot;</span><span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY1</span><span class="si">}</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>kubectl<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>generic<span class="w"> </span>dns-provider-coredns<span class="w"> </span>--namespace<span class="o">=</span>dnstest<span class="w"> </span>--type<span class="o">=</span>kuadrant.io/coredns<span class="w"> </span>--from-literal<span class="o">=</span><span class="nv">ZONES</span><span class="o">=</span><span class="s2">&quot;k.example.com&quot;</span><span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY2</span><span class="si">}</span>
</span></code></pre></div></p>
<p>Set the CoreDNS provider as the default allowing it to be selected when none is specified by the DNSPolicy:
<div class="language-shell highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>kubectl<span class="w"> </span>label<span class="w"> </span>secret/dns-provider-coredns<span class="w"> </span>-n<span class="w"> </span>dnstest<span class="w"> </span>kuadrant.io/default-provider<span class="o">=</span><span class="nb">true</span><span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY1</span><span class="si">}</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>kubectl<span class="w"> </span>label<span class="w"> </span>secret/dns-provider-coredns<span class="w"> </span>-n<span class="w"> </span>dnstest<span class="w"> </span>kuadrant.io/default-provider<span class="o">=</span><span class="nb">true</span><span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY2</span><span class="si">}</span>
</span></code></pre></div></p>
<h2 id="setup-cluster-3-secondary">Setup Cluster 3 (Secondary)<a class="headerlink" href="#setup-cluster-3-secondary" title="Permanent link">&para;</a></h2>
<p>Secondary clusters are optional.
A secondary does not have CoreDNS installed.
A secondary cluster does not have cluster kubeconfig secrets added.
A secondary cluster does not have provider credentials.</p>
<h3 id="dns-operator-configuration_1">DNS Operator Configuration<a class="headerlink" href="#dns-operator-configuration_1" title="Permanent link">&para;</a></h3>
<p>Clusters being configured as "secondary" should have the delegation role of the running dns operator set to "secondary".</p>
<p>This can be done by updating the dns operators configuration configmap(dns-operator-controller-env) in the kuadrant-system namespace and restarting the service:
<div class="language-shell highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>kubectl<span class="w"> </span>patch<span class="w"> </span>configmap<span class="w"> </span>dns-operator-controller-env<span class="w"> </span>-n<span class="w"> </span>kuadrant-system<span class="w"> </span>--type<span class="w"> </span>merge<span class="w"> </span>-p<span class="w"> </span><span class="s1">&#39;{&quot;data&quot;:{&quot;DELEGATION_ROLE&quot;:&quot;secondary&quot;}}&#39;</span><span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_SECONDARY1</span><span class="si">}</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>kubectl<span class="w"> </span>scale<span class="w"> </span>deployment/dns-operator-controller-manager<span class="w"> </span>-n<span class="w"> </span>kuadrant-system<span class="w"> </span>--replicas<span class="o">=</span><span class="m">0</span><span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_SECONDARY1</span><span class="si">}</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>kubectl<span class="w"> </span>scale<span class="w"> </span>deployment/dns-operator-controller-manager<span class="w"> </span>-n<span class="w"> </span>kuadrant-system<span class="w"> </span>--replicas<span class="o">=</span><span class="m">1</span><span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_SECONDARY1</span><span class="si">}</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>kubectl<span class="w"> </span>rollout<span class="w"> </span>status<span class="w"> </span>deployment/dns-operator-controller-manager<span class="w"> </span>-n<span class="w"> </span>kuadrant-system<span class="w"> </span>--timeout<span class="o">=</span>300s<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_SECONDARY1</span><span class="si">}</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>kubectl<span class="w"> </span>logs<span class="w"> </span>deployment/dns-operator-controller-manager<span class="w"> </span>-n<span class="w"> </span>kuadrant-system<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_SECONDARY1</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;delegationRole&quot;</span>
</span></code></pre></div></p>
<h3 id="create-test-namespace-dnstest_1">Create test namespace (dnstest)<a class="headerlink" href="#create-test-namespace-dnstest_1" title="Permanent link">&para;</a></h3>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>kubectl<span class="w"> </span>create<span class="w"> </span>ns<span class="w"> </span>dnstest<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_SECONDARY1</span><span class="si">}</span>
</span></code></pre></div>
<p>Cluster Setup complete, ready to deploy application!!</p>
<h2 id="deploy-toystore-application">Deploy Toystore application<a class="headerlink" href="#deploy-toystore-application" title="Permanent link">&para;</a></h2>
<p>Deploy the toystore application on all clusters:
<div class="language-shell highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/Kuadrant/Kuadrant-operator/main/examples/toystore/toystore.yaml<span class="w"> </span>-n<span class="w"> </span>dnstest<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY1</span><span class="si">}</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/Kuadrant/Kuadrant-operator/main/examples/toystore/toystore.yaml<span class="w"> </span>-n<span class="w"> </span>dnstest<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY2</span><span class="si">}</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/Kuadrant/Kuadrant-operator/main/examples/toystore/toystore.yaml<span class="w"> </span>-n<span class="w"> </span>dnstest<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_SECONDARY1</span><span class="si">}</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>dnstest<span class="w"> </span><span class="nb">wait</span><span class="w"> </span>--for<span class="o">=</span><span class="nv">condition</span><span class="o">=</span>Available<span class="w"> </span>deployments<span class="w"> </span>toystore<span class="w"> </span>--timeout<span class="o">=</span>60s<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY1</span><span class="si">}</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>dnstest<span class="w"> </span><span class="nb">wait</span><span class="w"> </span>--for<span class="o">=</span><span class="nv">condition</span><span class="o">=</span>Available<span class="w"> </span>deployments<span class="w"> </span>toystore<span class="w"> </span>--timeout<span class="o">=</span>60s<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY2</span><span class="si">}</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a>kubectl<span class="w"> </span>-n<span class="w"> </span>dnstest<span class="w"> </span><span class="nb">wait</span><span class="w"> </span>--for<span class="o">=</span><span class="nv">condition</span><span class="o">=</span>Available<span class="w"> </span>deployments<span class="w"> </span>toystore<span class="w"> </span>--timeout<span class="o">=</span>60s<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_SECONDARY1</span><span class="si">}</span>
</span></code></pre></div></p>
<h3 id="create-an-ingress-gateway">Create an Ingress Gateway<a class="headerlink" href="#create-an-ingress-gateway" title="Permanent link">&para;</a></h3>
<p>Create a gateway using the coredns zone name as part of a listener hostname on all clusters:</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="nv">gateway</span><span class="o">=</span><span class="k">$(</span>cat<span class="w"> </span><span class="s">&lt;&lt;EOF</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="s">apiVersion: gateway.networking.k8s.io/v1</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="s">kind: Gateway</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="s">metadata:</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="s">  name: external</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="s">  namespace: dnstest</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="s">  labels:</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="s">    kuadrant.io/gateway: &quot;true&quot;</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="s">spec:</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="s">  gatewayClassName: istio</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="s">  listeners:</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="s">    - name: http</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="s">      protocol: HTTP</span>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="s">      port: 80</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="s">      allowedRoutes:</span>
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="s">        namespaces:</span>
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="s">          from: All</span>
</span><span id="__span-18-19"><a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a><span class="s">      hostname: &quot;api.toystore.k.example.com&quot; </span>
</span><span id="__span-18-20"><a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a><span class="s">EOF</span><span class="k">)</span>
</span><span id="__span-18-21"><a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a>
</span><span id="__span-18-22"><a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">gateway</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY1</span><span class="si">}</span><span class="w"> </span>-f<span class="w"> </span>-
</span><span id="__span-18-23"><a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">gateway</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY2</span><span class="si">}</span><span class="w"> </span>-f<span class="w"> </span>-
</span><span id="__span-18-24"><a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">gateway</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_SECONDARY1</span><span class="si">}</span><span class="w"> </span>-f<span class="w"> </span>-
</span></code></pre></div>
<h3 id="setup-toystore-application-httproute">Setup Toystore application HTTPRoute<a class="headerlink" href="#setup-toystore-application-httproute" title="Permanent link">&para;</a></h3>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="nv">httproute</span><span class="o">=</span><span class="k">$(</span>cat<span class="w"> </span><span class="s">&lt;&lt;EOF</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="s">apiVersion: gateway.networking.k8s.io/v1</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="s">kind: HTTPRoute</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="s">metadata:</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="s">  name: toystore</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="s">  namespace: dnstest</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="s">  labels:</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="s">    deployment: toystore</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="s">    service: toystore</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="s">spec:</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="s">  parentRefs:</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="s">  - name: external</span>
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="s">    namespace: dnstest</span>
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="s">  hostnames:</span>
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="s">  - &quot;api.toystore.k.example.com&quot;</span>
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="s">  rules:</span>
</span><span id="__span-19-18"><a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="s">  - matches:</span>
</span><span id="__span-19-19"><a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a><span class="s">    - method: GET</span>
</span><span id="__span-19-20"><a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a><span class="s">      path:</span>
</span><span id="__span-19-21"><a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a><span class="s">        type: PathPrefix</span>
</span><span id="__span-19-22"><a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a><span class="s">        value: &quot;/cars&quot;</span>
</span><span id="__span-19-23"><a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a><span class="s">    backendRefs:</span>
</span><span id="__span-19-24"><a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a><span class="s">    - name: toystore</span>
</span><span id="__span-19-25"><a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a><span class="s">      port: 80  </span>
</span><span id="__span-19-26"><a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a><span class="s">EOF</span>
</span><span id="__span-19-27"><a id="__codelineno-19-27" name="__codelineno-19-27" href="#__codelineno-19-27"></a><span class="k">)</span>
</span><span id="__span-19-28"><a id="__codelineno-19-28" name="__codelineno-19-28" href="#__codelineno-19-28"></a>
</span><span id="__span-19-29"><a id="__codelineno-19-29" name="__codelineno-19-29" href="#__codelineno-19-29"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">httproute</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY1</span><span class="si">}</span><span class="w"> </span>-f<span class="w"> </span>-
</span><span id="__span-19-30"><a id="__codelineno-19-30" name="__codelineno-19-30" href="#__codelineno-19-30"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">httproute</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY2</span><span class="si">}</span><span class="w"> </span>-f<span class="w"> </span>-
</span><span id="__span-19-31"><a id="__codelineno-19-31" name="__codelineno-19-31" href="#__codelineno-19-31"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">httproute</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_SECONDARY1</span><span class="si">}</span><span class="w"> </span>-f<span class="w"> </span>-
</span></code></pre></div>
<h3 id="verify_2">Verify<a class="headerlink" href="#verify_2" title="Permanent link">&para;</a></h3>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>gateway,httproute,service,deployment,all<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY1</span><span class="si">}</span><span class="w"> </span>-n<span class="w"> </span>dnstest
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>kubectl<span class="w"> </span>get<span class="w"> </span>gateway,httproute,service,deployment,all<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY2</span><span class="si">}</span><span class="w"> </span>-n<span class="w"> </span>dnstest
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>kubectl<span class="w"> </span>get<span class="w"> </span>gateway,httproute,service,deployment,all<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_SECONDARY1</span><span class="si">}</span><span class="w"> </span>-n<span class="w"> </span>dnstest
</span></code></pre></div>
<h3 id="enable-dns-on-the-gateway">Enable DNS on the gateway<a class="headerlink" href="#enable-dns-on-the-gateway" title="Permanent link">&para;</a></h3>
<p>Create a Kuadrant <code>DNSPolicy</code> to configure DNS on all clusters:</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="nv">dnspolicyeu</span><span class="o">=</span><span class="k">$(</span>cat<span class="w"> </span><span class="s">&lt;&lt;EOF</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="s">apiVersion: kuadrant.io/v1</span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="s">kind: DNSPolicy</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="s">metadata:</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="s">  name: external-dns</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="s">  namespace: dnstest</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7" href="#__codelineno-21-7"></a><span class="s">spec:</span>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8" href="#__codelineno-21-8"></a><span class="s">  targetRef:</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9" href="#__codelineno-21-9"></a><span class="s">    name: external</span>
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10" href="#__codelineno-21-10"></a><span class="s">    group: gateway.networking.k8s.io</span>
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11" href="#__codelineno-21-11"></a><span class="s">    kind: Gateway</span>
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12" href="#__codelineno-21-12"></a><span class="s">  loadBalancing:</span>
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13" href="#__codelineno-21-13"></a><span class="s">    weight: 100</span>
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14" href="#__codelineno-21-14"></a><span class="s">    geo: GEO-EU</span>
</span><span id="__span-21-15"><a id="__codelineno-21-15" name="__codelineno-21-15" href="#__codelineno-21-15"></a><span class="s">    defaultGeo: true</span>
</span><span id="__span-21-16"><a id="__codelineno-21-16" name="__codelineno-21-16" href="#__codelineno-21-16"></a><span class="s">  delegate: true</span>
</span><span id="__span-21-17"><a id="__codelineno-21-17" name="__codelineno-21-17" href="#__codelineno-21-17"></a><span class="s">EOF</span>
</span><span id="__span-21-18"><a id="__codelineno-21-18" name="__codelineno-21-18" href="#__codelineno-21-18"></a><span class="k">)</span>
</span><span id="__span-21-19"><a id="__codelineno-21-19" name="__codelineno-21-19" href="#__codelineno-21-19"></a><span class="nv">dnspolicyus</span><span class="o">=</span><span class="k">$(</span>cat<span class="w"> </span><span class="s">&lt;&lt;EOF</span>
</span><span id="__span-21-20"><a id="__codelineno-21-20" name="__codelineno-21-20" href="#__codelineno-21-20"></a><span class="s">apiVersion: kuadrant.io/v1</span>
</span><span id="__span-21-21"><a id="__codelineno-21-21" name="__codelineno-21-21" href="#__codelineno-21-21"></a><span class="s">kind: DNSPolicy</span>
</span><span id="__span-21-22"><a id="__codelineno-21-22" name="__codelineno-21-22" href="#__codelineno-21-22"></a><span class="s">metadata:</span>
</span><span id="__span-21-23"><a id="__codelineno-21-23" name="__codelineno-21-23" href="#__codelineno-21-23"></a><span class="s">  name: external-dns</span>
</span><span id="__span-21-24"><a id="__codelineno-21-24" name="__codelineno-21-24" href="#__codelineno-21-24"></a><span class="s">  namespace: dnstest</span>
</span><span id="__span-21-25"><a id="__codelineno-21-25" name="__codelineno-21-25" href="#__codelineno-21-25"></a><span class="s">spec:</span>
</span><span id="__span-21-26"><a id="__codelineno-21-26" name="__codelineno-21-26" href="#__codelineno-21-26"></a><span class="s">  targetRef:</span>
</span><span id="__span-21-27"><a id="__codelineno-21-27" name="__codelineno-21-27" href="#__codelineno-21-27"></a><span class="s">    name: external</span>
</span><span id="__span-21-28"><a id="__codelineno-21-28" name="__codelineno-21-28" href="#__codelineno-21-28"></a><span class="s">    group: gateway.networking.k8s.io</span>
</span><span id="__span-21-29"><a id="__codelineno-21-29" name="__codelineno-21-29" href="#__codelineno-21-29"></a><span class="s">    kind: Gateway</span>
</span><span id="__span-21-30"><a id="__codelineno-21-30" name="__codelineno-21-30" href="#__codelineno-21-30"></a><span class="s">  loadBalancing:</span>
</span><span id="__span-21-31"><a id="__codelineno-21-31" name="__codelineno-21-31" href="#__codelineno-21-31"></a><span class="s">    weight: 125</span>
</span><span id="__span-21-32"><a id="__codelineno-21-32" name="__codelineno-21-32" href="#__codelineno-21-32"></a><span class="s">    geo: GEO-NA</span>
</span><span id="__span-21-33"><a id="__codelineno-21-33" name="__codelineno-21-33" href="#__codelineno-21-33"></a><span class="s">    defaultGeo: false</span>
</span><span id="__span-21-34"><a id="__codelineno-21-34" name="__codelineno-21-34" href="#__codelineno-21-34"></a><span class="s">  delegate: true</span>
</span><span id="__span-21-35"><a id="__codelineno-21-35" name="__codelineno-21-35" href="#__codelineno-21-35"></a><span class="s">EOF</span>
</span><span id="__span-21-36"><a id="__codelineno-21-36" name="__codelineno-21-36" href="#__codelineno-21-36"></a><span class="k">)</span>
</span><span id="__span-21-37"><a id="__codelineno-21-37" name="__codelineno-21-37" href="#__codelineno-21-37"></a>
</span><span id="__span-21-38"><a id="__codelineno-21-38" name="__codelineno-21-38" href="#__codelineno-21-38"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">dnspolicyeu</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY1</span><span class="si">}</span><span class="w"> </span>-f<span class="w"> </span>-
</span><span id="__span-21-39"><a id="__codelineno-21-39" name="__codelineno-21-39" href="#__codelineno-21-39"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">dnspolicyus</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY2</span><span class="si">}</span><span class="w"> </span>-f<span class="w"> </span>-
</span><span id="__span-21-40"><a id="__codelineno-21-40" name="__codelineno-21-40" href="#__codelineno-21-40"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">dnspolicyeu</span><span class="si">}</span><span class="s2">&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>kubectl<span class="w"> </span>apply<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_SECONDARY1</span><span class="si">}</span><span class="w"> </span>-f<span class="w"> </span>-
</span></code></pre></div>
<h3 id="verify_3">Verify<a class="headerlink" href="#verify_3" title="Permanent link">&para;</a></h3>
<p>Check the DNSRecord resources on each cluster: 
<div class="language-shell highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>dnsrecord<span class="w"> </span>-n<span class="w"> </span>dnstest<span class="w"> </span>-o<span class="w"> </span>wide<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY1</span><span class="si">}</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>kubectl<span class="w"> </span>get<span class="w"> </span>dnsrecord<span class="w"> </span>-n<span class="w"> </span>dnstest<span class="w"> </span>-o<span class="w"> </span>wide<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY2</span><span class="si">}</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>kubectl<span class="w"> </span>get<span class="w"> </span>dnsrecord<span class="w"> </span>-n<span class="w"> </span>dnstest<span class="w"> </span>-o<span class="w"> </span>wide<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_SECONDARY1</span><span class="si">}</span>
</span></code></pre></div></p>
<p>Check the authoritative DNSRecord resources on each primary:
<div class="language-shell highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>kubectl<span class="w"> </span>get<span class="w"> </span>dnsrecord/authoritative-record-oii1lttl<span class="w"> </span>-n<span class="w"> </span>dnstest<span class="w"> </span>-o<span class="w"> </span>json<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY1</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">&#39;.spec.endpoints[] | &quot;dnsName: \(.dnsName), recordType: \(.recordType), targets: \(.targets)&quot;&#39;</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>kubectl<span class="w"> </span>get<span class="w"> </span>dnsrecord/authoritative-record-oii1lttl<span class="w"> </span>-n<span class="w"> </span>dnstest<span class="w"> </span>-o<span class="w"> </span>json<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY2</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span>-r<span class="w"> </span><span class="s1">&#39;.spec.endpoints[] | &quot;dnsName: \(.dnsName), recordType: \(.recordType), targets: \(.targets)&quot;&#39;</span>
</span></code></pre></div></p>
<p>Check the k.example.com zone on each CoreDNS instance contains the expected records:
<div class="language-shell highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="nv">NS1</span><span class="o">=</span><span class="sb">`</span>kubectl<span class="w"> </span>get<span class="w"> </span>service/kuadrant-coredns<span class="w"> </span>-n<span class="w"> </span>kuadrant-coredns<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY1</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>yq<span class="w"> </span><span class="s1">&#39;.status.loadBalancer.ingress[0].ip&#39;</span><span class="sb">`</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="nv">NS2</span><span class="o">=</span><span class="sb">`</span>kubectl<span class="w"> </span>get<span class="w"> </span>service/kuadrant-coredns<span class="w"> </span>-n<span class="w"> </span>kuadrant-coredns<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY2</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>yq<span class="w"> </span><span class="s1">&#39;.status.loadBalancer.ingress[0].ip&#39;</span><span class="sb">`</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="nb">echo</span><span class="w"> </span><span class="nv">$NS1</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="nb">echo</span><span class="w"> </span><span class="nv">$NS2</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a>dig<span class="w"> </span>@<span class="si">${</span><span class="nv">NS1</span><span class="si">}</span><span class="w"> </span>-t<span class="w"> </span>AXFR<span class="w"> </span>k.example.com
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>dig<span class="w"> </span>@<span class="si">${</span><span class="nv">NS2</span><span class="si">}</span><span class="w"> </span>-t<span class="w"> </span>AXFR<span class="w"> </span>k.example.com
</span></code></pre></div></p>
<p>Check the CoreDNS instances respond as expected:
<div class="language-shell highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="nv">NS1</span><span class="o">=</span><span class="sb">`</span>kubectl<span class="w"> </span>get<span class="w"> </span>service/kuadrant-coredns<span class="w"> </span>-n<span class="w"> </span>kuadrant-coredns<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY1</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>yq<span class="w"> </span><span class="s1">&#39;.status.loadBalancer.ingress[0].ip&#39;</span><span class="sb">`</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="nv">NS2</span><span class="o">=</span><span class="sb">`</span>kubectl<span class="w"> </span>get<span class="w"> </span>service/kuadrant-coredns<span class="w"> </span>-n<span class="w"> </span>kuadrant-coredns<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY2</span><span class="si">}</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>yq<span class="w"> </span><span class="s1">&#39;.status.loadBalancer.ingress[0].ip&#39;</span><span class="sb">`</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>dig<span class="w"> </span>@<span class="si">${</span><span class="nv">NS1</span><span class="si">}</span><span class="w"> </span>api.toystore.k.example.com<span class="w"> </span>+short
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>dig<span class="w"> </span>@<span class="si">${</span><span class="nv">NS2</span><span class="si">}</span><span class="w"> </span>api.toystore.k.example.com<span class="w"> </span>+short
</span></code></pre></div></p>
<p>Delete DNSPolicy from all clusters:
<div class="language-shell highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>kubectl<span class="w"> </span>delete<span class="w"> </span>dnspolicy<span class="w"> </span>external-dns<span class="w"> </span>-n<span class="w"> </span>dnstest<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY1</span><span class="si">}</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>kubectl<span class="w"> </span>delete<span class="w"> </span>dnspolicy<span class="w"> </span>external-dns<span class="w"> </span>-n<span class="w"> </span>dnstest<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_PRIMARY2</span><span class="si">}</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>kubectl<span class="w"> </span>delete<span class="w"> </span>dnspolicy<span class="w"> </span>external-dns<span class="w"> </span>-n<span class="w"> </span>dnstest<span class="w"> </span>--context<span class="w"> </span><span class="si">${</span><span class="nv">CTX_SECONDARY1</span><span class="si">}</span>
</span></code></pre></div></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer id="footer" class="footer">
  <div class="copyright">
    <p>Copyright <strong><span>The Kuadrant Contributors</span></strong>.</p>
    <p>The Linux Foundation® (TLF) has registered trademarks and uses trademarks.</p> 
    <p>For a list of TLF trademarks, see <a href="https://www.linuxfoundation.org/trademark-usage/">Trademark Usage</a></p>
  </div>

  <div class="sponsored-by">
    <p>
      <a href="https://www.cncf.io/sandbox-projects/"><img src="../../../../../assets/images/cncf-color.png" class="logo" alt="CNCF logo"></a>
    </p>
    <p>
      We are a Cloud Native Computing Foundation sandbox project.
    </p>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../../../..", "features": ["content.action.edit", "content.code.copy"], "search": "../../../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": ["1.3.x", "latest"], "provider": "mike"}}</script>
    
    
      <script src="../../../../../assets/javascripts/bundle.83f73b43.min.js"></script>
      
    
  </body>
</html>